version: "3"
 
services:

  # Services
  # ============================
  twingate:
    image: twingate/connector:1
    environment:
      - TENANT_URL=${TENANT_URL}
      - ACCESS_TOKEN=${ACCESS_TOKEN}
      - REFRESH_TOKEN=${REFRESH_TOKEN}
      - TWINGATE_LABEL_HOSTNAME=${TWINGATE_LABEL_HOSTNAME}

  domain-controller:
    image: docker pull instantlinux/samba-dc
  
  dns-sinkhole:
    image: docker pull patterns/sinkhole

  proxy:
    image: mitmproxy/mitmproxy

  antivirus:
    image: rordi/docker-antivirus

  prometheus:
    image: prom/prometheus

    depends_on:
      - ${SERVICE}  
    ports:
      - "9090:9090"
    volumes: 
      - ./services/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml

  vnc:
    image: dorowu/ubuntu-desktop-lxde-vnc

    depends_on: 
      - ${SERVICE}

    ports:
    - "6080:80"
    
    volumes:
      - /dev/shm:/dev/shm

    # ports:
    #   - "6079:80"
  # Servers
  # ==============================
  ftp:
    image: delfer/alpine-ftp-server
    ports:
      - "21:21"
      - " 21000-21010:21000-21010"
    volumes:
      - "/media/boejaker/New Volume/Games:/Games"
    # build:
    #   context: ./
    #   dockerfile: ./services/ftp/.Dockerfile
    #   args:
    #     UBUNTU_IMAGE: ${UBUNTU_IMAGE}
    #     UBUNTU_DIGEST : ${UBUNTU_DIGEST}
    #     SERVER_REPO : ${SERVER_REPO}
    #     GITHUB_TOKEN : ${GITHUB_TOKEN}
    #     GITHUB_USERNAME : ${GITHUB_USERNAME}

    # depends_on:
    #   - ${SERVICE}

    # ports:
    #   - "8100:80"

    # volumes:
    #   - "/media/boejaker/New Volume/Games:/Games"
    # command: /bin/bash
    # tty: true
    
    # environment:
    #   - SERVER_MODE=${SERVER_MODE}

  alpine-server:
    build:
      context: ./
      dockerfile: ./server/Alpine/.Dockerfile
      args:
        ALPINE_IMAGE: ${ALPINE_IMAGE}
        ALPINE_DIGEST : ${ALPINE_DIGEST}
        SERVER_REPO : ${SERVER_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}

    depends_on:
      - ${SERVICE}

    ports:
      - "8000:8000"

    volumes:
      - ./server/alpine/app:/app

    tty: true
    
    environment:
      - SERVER_MODE=${SERVER_MODE}

  ubnuntu-server:
    build:
      context: ./
      dockerfile: ./server/ubnutu/.Dockerfile
      args:
        UBUNTU_SERVER_IMAGE: ${UBUNTU_SERVER_IMAGE}
        UBUNTU_SERVER_DIGEST : ${UBUNTU_SERVER_DIGEST}
        SERVER_REPO : ${SERVER_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}

    depends_on:
      - ${SERVICE}

    ports:
      - "8000:8000"

    volumes:
      - ./server/Alpine/app:/app

    tty: true
    
    environment:
      - SERVER_MODE=${SERVER_MODE}

  # Clients
  # ==============================
  windows-client:
    build:
      context: ./
      dockerfile: ./client/windows/.Dockerfile
      args:
        WINDOWS_IMAGE: ${WINDOWS_IMAGE}
        WINDOWS_DIGEST : ${WINDOWS_DIGEST}
        CLIENT_REPO : ${CLIENT_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}
    
    depends_on:
      - ${SERVICE}

    volumes:
      - ./client/windows/app:/app

    environment:
      - CLIENT_MODE=${CLIENT_MODE}


  android-client:
    build:
      context: ./
      dockerfile: ./client/android/.Dockerfile
      args:
        ANDROID_IMAGE: ${ANDROID_IMAGE}
        ANDROID_DIGEST : ${ANDROID_DIGEST}
        CLIENT_REPO : ${CLIENT_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}
    
    depends_on:
      - ${SERVICE}

    volumes:
      - ./clientandroid/app:/app

    environment:
      - CLIENT_MODE=${CLIENT_MODE}


  ios-client:
    build:
      context: ./
      dockerfile: ./client/ios/.Dockerfile
      args:
        IOS_IMAGE: ${IOS_IMAGE}
        IOS_DIGEST : ${IOS_DIGEST}
        CLIENT_REPO : ${CLIENT_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}

    depends_on:
      - ${SERVICE}

    volumes:
      - ./client/ios/app:/app

    environment:
      - CLIENT_MODE=${CLIENT_MODE}


  osx-client:
    build:
      context: ./
      dockerfile: ./client/osx/.Dockerfile
      args:
        OSX_IMAGE: ${OSX_IMAGE}
        OSX_DIGEST : ${OSX_DIGEST}
        CLIENT_REPO : ${CLIENT_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}
    
    depends_on:
      - ${SERVICE}

    volumes:
      - ./client/osx/app:/app

    environment:
      - CLIENT_MODE=${CLIENT_MODE}

  ubuntu-client:
    build:
      context: ./
      dockerfile: ./client/ubuntu/.Dockerfile
      args:
        UBUNTU_IMAGE : ${UBUNTU_IMAGE}
        UBUNTU_DIGEST : ${UBUNTU_DIGEST}
        CLIENT_REPO : ${CLIENT_REPO}
        GITHUB_TOKEN : ${GITHUB_TOKEN}
        GITHUB_USERNAME : ${GITHUB_USERNAME}
     
    ports:
      - "80:80"
    
    depends_on:
      - ${SERVICE}

    volumes:
      - ./client/ubuntu/app:/app
    
    environment:
      - CLIENT_MODE=${CLIENT_MODE}
      - CLIENT_REPO=${CLIENT_REPO}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_USERNAME=${GITHUB_USERNAME}
    
    # command: /bin/bash
    tty: true

# Volumes
# ==============================
volumes:
  server:
  client:

# Example composition
#======================
# # Set the operating mode
# SERVER_MODE="normal" CLIENT_MODE="normal"\ 
#
# # Set the version digest (aquired from hub.docker.com)
# SERVER_DIGEST="@sha:1234abcd..." IOS_DIGEST="@sha:1234abcd..." \
#
# # Set the target repos
# SERVER_REPO="https://github.com/..." CLIENT_REPO="https://github.com/..."\
#
# # Compose the testbench
# docker compose up server ios-client
#
# This will start both a server and IOS client container connected on a network
#
# docker compose run -e SERVER_MODE="normal" CLIENT_MODE="normal"\ 
# -e SERVER_DIGEST="sha256:b6ca290b6b4cdcca5b3db3ffa338ee0285c11744b4a6abaa9627746ee3291d8d" -e UBNUTU_DIGEST="sha256:7a57c69fe1e9d5b97c5fe649849e79f2cfc3bf11d10bbd5218b4eb61716aebe6"
# -e SERVER_REPO="https://gist.github.com/BoeJaker/86659a8e647496a5f5b24b33048f739a" -e CLIENT_REPO="https://gist.github.com/BoeJaker/6d30208bd42b3769f593a9e95e29a873"\
# server ubuntu-client
#
#You can also set environment variables via the .env file, see env.dummy for more info
#
# See REAME.md for more information